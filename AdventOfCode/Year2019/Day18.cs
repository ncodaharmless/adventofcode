using AdventOfCode.Utils;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AdventOfCode.Year2019
{


    class CharMap : GridMap<char>
    {
        public class DistanceMap : GridMap<uint>
        {
            public uint Distance(Point point)
            {
                return this[point];
            }

            public DistanceMap(int width, int height) : base(width, height)
            {
                for (int y = 0; y < Height; y++)
                    for (int x = 0; x < Width; x++)
                        this[x, y] = uint.MaxValue;
            }
        }

        public Func<char, bool> IsTarget = (c) => false;

        public Dictionary<Point, char> Targets;
        public bool StopOnTarget;

        public DistanceMap CorridorDistance(Point from, Func<char, bool> isWall)
        {
            Targets = new Dictionary<Point, char>();
            var distMap = new DistanceMap(Width, Height);
            CorridorDistance(distMap, isWall, from, 0);
            return distMap;
        }
        private void CorridorDistance(DistanceMap dist, Func<char, bool> isWall, Point from, uint distance)
        {
            if (from.X < 0 || from.Y < 0 || from.X >= Width || from.Y >= Height) return;
            int index = from.Y * Width + from.X;
            char cell = this[index];
            if (isWall(cell)) return;
            if (dist[index] > distance)
            {
                dist[index] = distance;
                if (IsTarget(cell))
                {
                    if (!Targets.ContainsKey(from))
                        Targets.Add(from, cell);
                    if (StopOnTarget) return;
                }
                CorridorDistance(dist, isWall, from.Left(), distance + 1);
                CorridorDistance(dist, isWall, from.Right(), distance + 1);
                CorridorDistance(dist, isWall, from.Up(), distance + 1);
                CorridorDistance(dist, isWall, from.Below(), distance + 1);
            }
        }

        public CharMap(CharMap cloneSource) : base(cloneSource.Width, cloneSource.Height)
        {
            cloneSource._Data.CopyTo(_Data, 0);
            IsTarget = cloneSource.IsTarget;
        }

        public CharMap(string[] lines) : base(lines[0].Length, lines.Length)
        {
            _Data = new char[Height * Width];
            for (int y = 0; y < Height; y++)
                for (int x = 0; x < Width; x++)
                    _Data[y * Width + x] = lines[y][x];
        }
    }

    class Day18
    {
        #region Input
        const string Input = @"
#################################################################################
#...#..j..........#.........#...........#.......#........n......#.....#........m#
#.#.#.#.###########.###.#####.#######O#####.###.#.#########.#.###.#.###.###.###.#
#.#.#.#...............#.Z.......#...#...#...#.#.#.#.......#.#.....#.....#.X.#...#
#.#.#.###########################P#.#.#.#.###.#.###.#####.###.###########.###.###
#.#.#.#.......#.........#......b..#.#.#.#.#.......#...#.#...#.....#.......#.....#
#.#.#.#.###.###.#######.#.#########.###.#.#######.###.#.###.#####.#.#############
#.#.#.#.#...#...#..l#...#.#.......#.#...#.....#.......#.#...#.....#.........#..k#
#.###.#.###.#.#####.#.###.#######.#.#.###.###.#########.#.###.#####.#######.#.#.#
#...#.#...#.#.#...#...#...#.....#.#...#.#...#...#.....#.#.#...#...#...#...#...#.#
#.#.#.#.#.###.#.#U###.###.#.###.#.#####.###.###.#.###.#.#.#.###.#.#####.#.#####F#
#.#.#.#.#...#...#...#.....#.#...#.......#...#g#...#.#.#...#.#...#...#.E.#.....#.#
#.#.#.#.###.#######.#######.###.###Y#.###.###.#####.#.###.###.#####.#.#######.#.#
#.#...#...#...#.....#......a..#...#.#...#.....#.....#...#.....#.......#.....#...#
#.#####D#####.#.#######.#####.###.###.#.#####.#.###.###.#################.#####.#
#.M...#.#...#.#.#c....#...#...#.#...#.#.#...#.#.#.#.#.#.#...............#...#...#
#####.###.#.#.#H#.###.#####.###.###.#.#.#.###.#.#.#.#.#.#.###########.#.###.#.###
#...#.....#.#.#.#...#...#...#.....#.#.#.#...#.#.#.....#.......#.....#.#.#...#.#.#
#.#.#######.#.#.#.#####.#.###.#.###.###.#.#.#.#.#####.#########.###.###.#.###.#.#
#.#.#....x#.#.#...#.....#.#...#.#..i#...#.#.#.#...#...#.........#.....#.#...#...#
#.###K#.#.#.#.#####.#####.#.###.#.###.#####.#.###.#####.###.#########.#.#.#.###.#
#...#.#.#.#.#.....#..r#...#...#.#.#.....#...#.....#.....#...#.......#...#.#.....#
#.#.#.#.###.#.###.#####.#####.#.#.#.###.#.#####.###.#####.#########.#####.#####.#
#.#.#.#.....#.#.........#.....#.#.#...#.#.......#...#...#.#.........#.....#...#.#
###.#.#########.#########.#####.#.#####.#####.###.#.#.#.###.#########.#####.#.#.#
#...#...#.....#.#...........#...#.....#.#..t#.#.#.#.#.#.....#...#.........#.#.#.#
#.#####.#.#.#.#.#####.#####.#########.#.#.#.#.#.#.#.#.#######.###.#########.#.###
#.......#.#.#.#.....#...#.#.....#...#.#.#.#.#...#.#.#.....#.......#...#...#.#...#
#.#########.#.###.#.###.#.#####.#.#.#.#.#.#.#####.#.#####.#########.#.#.#.#.###.#
#.#.....#...#...#.#.#...#...#...#.#...#.#.#.......#.#...#.......#q..#...#...#...#
#.###.#.#.#####.###.###.#.###.###.#####.#.#########.###.#######.#.###########.###
#.....#.#...#.#...#...#.#...#...#...#...#...#...#.#.....#.......#.#...#.....#...#
#######.#.#.#.###.#.#.#.###.###.###.###.#.#.#.#.#.#####.#.#######.#.###.#.#####.#
#.....#.#.#.#.....#.#.#.......#...#.....#.#.#.#.#.#.....#.#...#...#...#.#.....#.#
#.#.###.#.#.###.#####.#####.###.#.#####.#.#.#.#.#.#.#####.#.#.#.#####.#.#####.#.#
#.#.#...#.#...#.#...#.#.....#...#...#...#.#...#.#...#...#...#...#.....#.#.....#.#
###.#.###.###.#.#.#.#.#######.#######.###.#####.#.###.#.#########.#.###.#.###.#.#
#...#.#...#...#.#.#.#...#.....#.....#.#.#.#...#.#.#...#.......#...#.....#...#.#.#
#.###.#####.###.#.#.###.#.#####.###.#.#.#.###.#.###.#######.###.###########.###.#
#...........#.....#.....#.........#...........#...........#...............#w....#
#######################################.@.#######################################
#.....#.....#.......#.........#...................#.#...................#...#...#
#.###.###.#.#.#####.#.#.#####.#.#####.#.#.#######.#.#.###############.#.#.#.#.#.#
#...#.....#...#.#...#.#...#.#.#.#.#...#.#.......#...#...#...#...#...#.#...#...#.#
###.#####.#####.#.#######.#.#.#.#.#.###.#.#####.###.###.#.###.#.#.#.#.#########.#
#...#...#.#...#.#.....#...#...#...#...#.#.#...#...#.#...#.#...#...#.#.........#.#
#.###.#.###.#.#.#####.#.###.#########.#.#.###.###.###.###.#.#######.###########.#
#.....#.....#.#.....#...#.#.#.......#.#.#.......#.....#...#.#...................#
#############.#####.#####.#.#.#####.#.#.#######.#######.#.#.###.###############.#
#...........#.....#.......#.#...#.#.#.#.#.....#.........#.#...#.#.........#...#.#
#########.#.#####.#.###.###.###.#.#.#.###.#.#.#######T#######.###.#######.#.###.#
#........f#.#...#.#...#.....#...#...#...#.#.#.#.....#.#.......#...#...#...#.#...#
#.#######.###.#.#.#####.#####.###.#####.#.#.#.#.###.#.#.#######.#####.#.###.#.###
#.#.#.....#...#.#.....#.......#...#.....#.#.#.#.#.#...#.#...#.......#.#.#.......#
#.#.#.#####.###.#.###.#########.###.#.###.#.###.#.#####.#.#.#.#####.#.#.#######.#
#.#.#...#...#.#.#...#.#...#...#.#.#.#...#.#...#.#...#...#.#...#...#...#.#.....#.#
#.#.###.#.###.#.###.#.###.#.#.#.#.#.###.#####.#.#.#.#.###.#####.#.#####.#.###.#.#
#.#.....#.#...#...#.#...#...#.#.#...#.#.#.....#.#.#.#.......#...#.#...#....s#.#v#
#.#.#####.#.#.###.###.#.#.###.#.###.#.#.#.#####.###.#####.###.###.#.#.#######.#.#
#.#...#...#.#...#...#.#.#...#.#...#..y#.#.#.........#...#.#...#.....#.........#.#
#.###.#.#######.###.###.#####.###.#####.#.#.#####.###.#.###.#########.###########
#.#...#.........#.#...#.....#...#.#.....#...#...#.#...#...#.#.......#.#.........#
#.#.###########.#.#########.#.###.#.#########.#.#.#.#####.#.#######R###.#######.#
#.#.#.....Q...#...#.........#...#.#.#...#...#.#.#.#.#...#.....#...#.....#...#.C.#
#.###.#.#########.#.###.#######.#.#.#.#.#.#.#.#.#.#.###.#####.#.#.#########.#.###
#...#.#...#...G.#.#...#.#.#.....#.#...#.#.#.#.#.#.#...#...#...#.#.....#.....#.#.#
#.#.#.###.#.###.#.#####.#.#.#.###.#####.#.#.#.#.#.###.#.#.#.#####.###.#.#####.#.#
#.#.#...#.#.#...#.#.....#.#.#.#...#...I.#.#...#.#...#.#.#.#.#.....#.#...#...#...#
#.#S###.#.#.#.#.#.#.#####.#.#.#.###.###.#.#####.#####.#.#.#.###.###.###.#.#.###.#
#.#.....#...#.#.#...#.......#...#...#.#.#.....#.......#.#.#...#.#.#...#.#.#.....#
#.###########.#######.###########.###.#.#.###.#########.#.###.#.#.#.#.#.#.#######
#e#.......#...#.....#.#.......#...#.#...#.#...#...#.#...#.......#...#...#.#.....#
#.#.#######.#.#.#.###.#.###.###.#.#.#.###N#.###.#.#.#.#########.#####.###.#.###.#
#.#.#.......#.#.#.....#...#.#...#.#.....#.#.#...#.#.#.#..p..#...#...#...#h..#.#.#
#.#.#.#########W#########.#.#.###.#####.###.#.###.#.#.#.###.#####.#B#########.#.#
#...#d....#...#.....#...#.#.....#.....#.#...#.#.#.#.#.#...#.#.....#.#.......#...#
###.#####.#.#.#####.#.#.###.#######.#.#.#.###.#.#.#.#.###.#.#.#####.#.#####.#.###
#...#...#...#.....#...#.V.#.#.....#.#.#.#.#...#z#.#...#...#.#...#.#...#.#.L.#.#.#
#.#####.#######.#########.###.###.###.#.#.#.###J#.#####.###.###.#.#####.#.###.#.#
#.............#...............#.....A.#.#.......#........o#.............#....u..#
#################################################################################";
        #endregion

        private CharMap _Map;
        readonly Point StartLocation;
        private Dictionary<Point, CharMap.DistanceMap> _OpenDoorDistances = new Dictionary<Point, CharMap.DistanceMap>();
        int SearchDepth = 2;

        public Day18(string input = Input)
        {
            _Map = new CharMap(input.SplitLine());

            StartLocation = _Map.FindFirst('@').Value;
        }

        internal int Part1()
        {
            foreach (Point keyPos in _Map.FindAll(m => char.IsLetter(m) && char.IsLower(m)))
            {
                _OpenDoorDistances.Add(keyPos, _Map.CorridorDistance(keyPos, w => w == '#'));
            }

            _Map.IsTarget = (c) => char.IsLetter(c) && char.IsLower(c);

            uint totalDistance = ShortedPathForAllKeys(_Map, StartLocation, 0);

            return (int)totalDistance;
        }

        private uint ShortedPathForAllKeys(CharMap map, Point currentLocation, uint distance)
        {
            var distanceMap = map.CorridorDistance(currentLocation, (c) => c == '#' || (char.IsLetter(c) && char.IsUpper(c)));
            if (map.Targets.Count == 0) return distance;
            uint shortestToFinish = int.MaxValue;
            foreach (var item in map.Targets.OrderBy(t => _OpenDoorDistances[t.Key].Distance(currentLocation)).Take(SearchDepth))
            {
                uint targetDistance = distanceMap.Distance(item.Key);
                CharMap cloneMap = new CharMap(map);
                char key = item.Value;
                char door = char.ToUpper(key);
                cloneMap[item.Key] = '.';
                Point? doorPoint = cloneMap.FindFirst(door);
                if (doorPoint.HasValue)
                    cloneMap[doorPoint.Value] = '.';
                uint thisDist = ShortedPathForAllKeys(cloneMap, item.Key, targetDistance + distance);
                if (thisDist < shortestToFinish)
                    shortestToFinish = thisDist;
            }
            return shortestToFinish;
        }

        internal int Part2()
        {
            throw new NotImplementedException();
        }
    }

    [TestClass]
    public class TestDay18
    {
        [TestMethod]
        public void Example1()
        {
            var d = new Day18(@"
#########
#b.A.@.a#
#########");
            Assert.AreEqual(8, d.Part1());
        }

        [TestMethod]
        public void Example2()
        {
            var d = new Day18(@"
########################
#f.D.E.e.C.b.A.@.a.B.c.#
######################.#
#d.....................#
########################");
            Assert.AreEqual(86, d.Part1());
        }

        [TestMethod]
        public void Example3()
        {
            var d = new Day18(@"
########################
#...............b.C.D.f#
#.######################
#.....@.a.B.c.d.A.e.F.g#
########################");
            Assert.AreEqual(132, d.Part1());
        }

        [TestMethod]
        public void Example4()
        {
            var d = new Day18(@"
#################
#i.G..c...e..H.p#
########.########
#j.A..b...f..D.o#
########@########
#k.E..a...g..B.n#
########.########
#l.F..d...h..C.m#
#################");
            Assert.AreEqual(136, d.Part1());
        }

        [TestMethod]
        public void Example5()
        {
            var d = new Day18(@"
########################
#@..............ac.GI.b#
###d#e#f################
###A#B#C################
###g#h#i################
########################");
            Assert.AreEqual(81, d.Part1());
        }

        [TestMethod]
        public void Part1()
        {
            Assert.AreEqual(0, new Day18().Part1());
        }
        [TestMethod]
        public void Part2()
        {
            Assert.AreEqual(0, new Day18().Part2());
        }
    }

}
