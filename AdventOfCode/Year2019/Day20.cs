using AdventOfCode.Utils;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AdventOfCode.Year2019
{


    class Day20
    {
        #region Input
        const string Input = @"
                                       Z       C       Q   C             O   H                                       
                                       F       Z       K   B             Y   F                                       
  #####################################.#######.#######.###.#############.###.#####################################  
  #...#.#.........#.....#.#...........#.#...#.....#.......#...#...#.........#.....#...........#.#.#.#.#.....#.....#  
  ###.#.#####.###.#.###.#.#########.#.#.###.###.#####.#####.#.###.#.#######.###.#####.#########.#.#.#.#.#######.###  
  #.#.....#...#.......#.....#.#.....#.#.......#...#.....#...#...#.....#...#.#.....................................#  
  #.#.###########.#.###.###.#.#####.#.#.#.#.#####.#.#.###.#.#######.#.#.#.###.###.#.#########.#.#.#.#.###.#####.#.#  
  #...#.....#.....#.#.....#...#.....#.#.#.#.#...#.#.#.#...#.......#.#...#.#...#...#.#.......#.#.#.#.#.#.#...#...#.#  
  ###.#.#######.#.#########.#.#####.#.###.#####.#.#.###########.#########.#.#.#####.#.#########.###.###.#########.#  
  #.........#...#.#...#.#...#.......#.#...#.......#.......#.#.#...#.#...#.#.#...#.#.#...#.#.#.#.#.#.#...#.......#.#  
  ###.#.#.#####.#.#.###.###########.#.#.#.#.#############.#.#.#.###.#.#.#.#####.#.###.###.#.#.###.###.#######.#####  
  #.#.#.#...#.#.#.#...#...#.#...#.#.#...#.#.#...#.........#...#...#...#...#.............................#.#...#.#.#  
  #.#.###.#.#.#######.###.#.###.#.#.#.#####.#.###.#.###.###.#.###.#.#.#.###.###.#####.#.#.#####.#########.###.#.#.#  
  #.#.#...#.#...#.....#.#...........#...#...#.#...#.#...#.#.#.....#.#.#...#.#.......#.#.#...#.......#.#.#.....#.#.#  
  #.#.#.#####.#######.#.#.#####.#.#.#######.#.#####.#.#.#.#.###.###.#.#.###.#.#####.###.#######.#.###.#.###.#.#.#.#  
  #...#.#.....#.......#.#.#...#.#.#.......#.....#.#.#.#.#...#.....#.#.#.#...#.....#.#.......#...#.#...#.#...#.#...#  
  #.#.#####.#####.###.#.#####.#####.###.###.#.###.#.#####.#.###.###.#######.#####.###########.#.#####.#.###.###.###  
  #.#.........#...#...#...#...#...#...#...#.#.#.......#.#.#...#.#.#...#.#.......#...#.......#.#.#.#.....#.........#  
  ###.###############.###.###.###.#.#.#.#####.#####.###.#####.#.#.###.#.#####.###.#.#.#####.#####.###.#######.#####  
  #.#.#.....#.....#.................#.#.#.....#...#...#.#.#...#.#.#.#...#.......#.#.......#.#.#...#...#...#.#.....#  
  #.#.###.#.###.#.###.#######.###.#.#########.#.#.#.###.#.#.#####.#.#.#######.#########.#####.#.#####.#.###.#.#.###  
  #...#.#.#.#.#.#.....#.......#...#.#...#...#...#.#...#...........#.........#.#.#.....#...#...#.#...#.#.#.#.#.#.#.#  
  ###.#.#.###.#######.#####.#######.#.#.###.#####.#.#############.#.###.#####.#.###.#######.###.###.#.#.#.#.#.###.#  
  #.#...#...#...#.#...#.#...#...#.....#.#.........#...#.#.........#.#.......#...........#...#...#.#.#.....#.#.#...#  
  #.#.#.###.###.#.#####.#.#####.#####.#####.#######.###.#.#.#######.###.#####.#####.#######.#.###.#.#.#.###.#.###.#  
  #...#.#.#.#...#...#...#.#...#.#.#.....#...#...#.......#.#.......#...#...#.#.#.#.#.....#...#.....#...#.#.....#.#.#  
  #.#.###.#.#.#####.###.###.###.#.#.#.###.#.#.#.###.#############.###.#####.#.#.#.#########.#.#.#####.###.#####.#.#  
  #.#.#...#.#.....#...#.....#.......#.#...#...#...#.#.....#.#.....#...#.#.......#...#...#...#.#...#.#...#...#.#.#.#  
  #.###.###.#.#####.###.###.###.###.###.#########.#.#.#.###.#.###.#.###.###.#.###.###.#####.#.#.###.###.#.#.#.#.#.#  
  #...#.#...#...#.#...#.#...#...#.....#.#.........#...#...#.....#.#.......#.#.......#.......#.#.#.#.#.....#.#.....#  
  #.###.#.###.###.#.#######.#######.#######.###########.#######.#######.###.###########.###.###.#.#.#####.###.#.#.#  
  #...#.....#.#.#.#.....#...#.#    N       M           B       H       Q   Z          #...#.....#.#.#.....#...#.#.#  
  ###.#.#####.#.#.#.#.#.###.#.#    L       T           F       F       K   F          #####.###.#.#.#####.#######.#  
  #...............#.#.#.#.#...#                                                       #.#...#...#.#...#.......#....HL
  ###.###.#####.###.#####.#.#.#                                                       #.###.#####.###.#####.#####.#  
VR......#...#.........#...#.#.#                                                     RF......#.........#...#...#...#  
  ###.#######.#####.###.#####.#                                                       #.#.#########.#####.#.#.#.###  
  #.#...#.....#...#.#...#.....#                                                       #.#...................#...#.#  
  #.#########.#.#.###.#.#.#.#.#                                                       ###########################.#  
  #...#.#.......#.....#...#.#..PQ                                                   BO....#...........#.....#.#...#  
  ###.#.#######################                                                       ###.#.#####.#.###.###.#.#.#.#  
OS....#.......................#                                                       #.......#.#.#.......#.....#..FS
  ###.#.###########.#.###.###.#                                                       #########.#############.#.###  
  #...#...#...#.#...#.#.#.#.#..GW                                                     #.....#.....#.#...#...#.#.#..FV
  #.#####.#.#.#.###.#.#.###.#.#                                                       #.###.#.###.#.#.#.#.#######.#  
  #.#...#...#.....#.#.......#.#                                                       #.#.#...#.......#...#.....#.#  
  #.#.#.#######.#####.#####.###                                                       #.#.#.#.###.#.###.###.#.#.#.#  
  #...#...........#.#.#.#.#.#.#                                                     CB....#.#.#...#.#...#...#.#...#  
  ###############.#.###.#.###.#                                                       #.#######.#####.###.#.#####.#  
  #.....#.......#...#...#.....#                                                       #.#.#...#...#.......#.....#.#  
  #.#.#.#.#####.#.#####.#####.#                                                       ###.###.###############.#####  
HP..#.#.....#...#.#.#.#.....#.#                                                       #...#.................#.#...#  
  #####.#####.#####.#.#.#####.#                                                       #.#####.#.###.#.###.#####.###  
  #.#...#.#...#.......#...#...#                                                     GY........#...#.#.#.#.........#  
  #.#.###.#.###.#.###.#.###.###                                                       #.###.#.#######.#.#.###.###.#  
  #.#.#.........#.#............KD                                                     #...#.#.#.#.#.#...#.#.#.#...#  
  #.#####.#####.###########.###                                                       #########.#.#.#.#.###.#.#####  
FR......#.#...#...#...#...#...#                                                       #.#.....#.#...#.#...#........BF
  #.###.#.#.#####.#.###.#.#####                                                       #.#.#####.#.#########.#######  
  #...#.#.#.....#...#...#.....#                                                     HL..#...#.#...#...#.#.#.#.#....PM
  ###.###.#.#########.#######.#                                                       #.#.###.#.#.###.#.#.###.###.#  
  #.....#.#...#.....#.....#.#..PM                                                     #...#.....#.#.#.......#......GW
  #.#######.#####.#.#####.#.###                                                       #.#.#.#.###.#.#.###.#####.###  
  #...............#.........#.#                                                     FV..#...#.#.......#...........#  
  #########.#.#####.#.#.#####.#                                                       ###########.#################  
  #...#.#...#.#...#.#.#...#...#                                                       #.#...#...#.#...#.#...#......SN
  #.#.#.###.#.###.#.#######.#.#                                                       #.#.#####.#####.#.#.#.#.#####  
AA..#...#.#.#.#.#.....#.#...#..MS                                                   HP........#.....#.....#.#.#...#  
  #.#.###.#####.#.###.#.#.###.#                                                       ###.#.###.#.###.#.#.#.#.###.#  
  #.#.....#.#.#.#...#.#.....#.#                                                       #...#...#.#.#...#.#.#.#...#.#  
  #.###.###.#.#.###########.#.#                                                       #.#########.###.#####.###.###  
NL..#.......................#.#                                                       #...............#...........#  
  #############.#.###.#.#.#####                                                       #########.#.#######.#########  
  #.#.........#.#...#.#.#.#...#                                                     FS..#.#...#.#...#...#.#.#...#..QR
  #.###.###.###.###########.#.#                                                       #.#.###.#########.###.#.#.#.#  
AE..#...#...#.#.#...#.......#.#                                                       #...#.....#...#.......#.#.#.#  
  #.#.#####.#.###.#####.#####.#                                                       #.#.###.###.#.#####.#.#.#.#.#  
  #.#.#.........#...#.#.#.....#                                                       #.#.#...#.#.#.#.#.#.#.#.#.#.#  
  #.#.#####.#.#.#.###.#.#.#####                                                       #.#####.#.#.###.#.#.#.#.#.#.#  
  #.......#.#.#.........#......FR                                                     #...................#...#...#  
  ###.#.#.#.###.###.#.###.#.###                                                       #.#.###.#.#.###.###.#.###.###  
  #...#.#.#.#.....#.#...#.#...#                                                       #.#.#...#.#...#.#...#.#.....#  
  ###.###.###.#########.#.#.#.#        C       Q   O         A   V       S       O    #.#.#####.#############.#####  
  #.....#.#.........#...#.#.#.#        Z       R   S         E   R       N       Y    #.#.....#.....#.#...........#  
  #.#.#.###.#.#.###.#.#.#.#.###########.#######.###.#########.###.#######.#######.#####.#.#.###.#####.###.#.#.#####  
  #.#.#...#.#.#.#...#.#.#.#.#.#.....#...#.#.....#.........#.....#...#.#.........#...#.#.#.#.#.......#...#.#.#.#.#.#  
  #.###.#########.#.###.#####.###.#.###.#.###.#.#.#####.#######.#.###.#.###.#####.###.#####.###.#.###.#####.###.#.#  
  #...#.#.......#.#...#.#.......#.#...#...#.#.#.#.....#.#.......#.#.#.#.#.....#.......#.#.#...#.#.........#.......#  
  #.#.#.#.###.#####.#.#.###.###.#.###.#.#.#.###.###.###########.#.#.#.#####.#.#.#######.#.###.#.###.###.#.###.#.###  
  #.#.#.....#.#...#.#.#.#...#...#.#...#.#.#.....#.........#...#.#.#.#.#.....#.#...#.#...#.#.#.#.#.....#.#.#...#.#.#  
  #.###########.###############.#.#.###.#####.#.#.#.#####.#.#.#.#.#.#.###.###.###.#.###.#.#.#.#.#.#.#.###.###.#.#.#  
  #...............#.#...#.#.#.#...#.......#...#.#.#.#.#.#.#.#...#.......#...#...#.........#...#.#.#.#...#...#.#...#  
  ###.#.###.###.#.#.#.#.#.#.#.###.###.###.#####.#.###.#.#######.###.#########.#.#.###.#.#.###.#.#.###.#.#.###.#.###  
  #.#.#...#.#.#.#...#.#.....#...#...#.#.#.#.....#.......#.....#.#...#.#.#.....#.#.#.#.#.#.#...#.#.#...#.#.#.#.#...#  
  #.#.#####.#.#############.#.###.#####.###.###.#.###.#######.#.#.###.#.#.#######.#.###.#####.#.###.#.#.###.###.###  
  #.#...#...........#...#...........#.#...#.#...#...#...#.......#.....#.........#...#.#.#.#.#.#.#...#.#.#.........#  
  #.#.###.###.#########.#.###.###.###.###.###.###.#.#########.#.#.#######.#.#.###.###.#.#.#.#.#.#.#.#########.#####  
  #.....#.#.......#.#.#.....#.#.#.#...#...#.#...#.#.#.....#...#.#.#.#...#.#.#...#.....#.....#.#.#.#.....#.......#.#  
  ###.#.#####.#####.#.#.#######.#.#.#.###.#.###.#.###.#.#######.#.#.#.#######.###.###.#######.###.#.#.###.#.#.###.#  
  #.#.#.#.......#...#...#...#.....#.#.........#.#.#...#.#.#.#.#.#.#...#.#.....#.#.#.........#.#.#.#.#...#.#.#.....#  
  #.###.###.#.#.###.#######.#.###.#######.###.#.#.###.###.#.#.#.#.#.#.#.#.#.#.#.#.###.#.#######.#.#############.#.#  
  #.......#.#.#.#.#.#.#...#.#.#.......#...#.#...#.......#.......#...#.#.#.#.#.#.#...#.#.#...#...#.#.#.#...#.....#.#  
  #.#.#####.#.#.#.#.#.###.#.#####.#####.#.#.#########.#####.#.#######.#.#####.#.#.#########.#.#####.#.#.#######.###  
  #.#.#.....#.#.#.........#.#.........#.#.....#.#.....#.#...#...#...#.....#.#.#...........#.............#.#.#.....#  
  #######.#.#####.#####.#.#.#.#####.#######.#.#.#.#####.#######.#.#.#.#####.#.#.###########.#####.#######.#.###.#.#  
  #.#.....#...#...#...#.#...#.#.#.......#...#...#...#...#...#.#.#.#...#.......#.....#.#.#.....#.#...#.........#.#.#  
  #.###.#.#.#######.###.#.#.###.#######.#######.###.###.#.###.#.#.#######.#######.###.#.###.###.#####.#####.#####.#  
  #.#...#.#.#.....#.....#.#...........#.#.#.#.#...#.....#.......#...#...#.....#.........................#.......#.#  
  #.#.###.#######.#.###.###.#######.###.#.#.#.#.#######.#.#########.#.#.#.#.#.#.#####.###########################.#  
  #.#.#.....#.....#.#.#.#.....#.#.......#.......#.......#.......#.....#.#.#.#.#.#...#.....#.........#.....#.#...#.#  
  #.#.###########.###.###.###.#.#.#######.#######.#########.#.#########.###.#.#.#.###.###.#.###.###.#.#####.#.###.#  
  #.......#.................#.#.......#.......#.........#...#.#.........#...#.#.....#.#.......#.#...............#.#  
  ###################################.#######.#######.#######.###.###########.#.#.#################################  
                                     B       R       M       P   K           G M Z                                   
                                     O       F       S       Q   D           Y T Z                                   ";
        #endregion

        internal class TeleportPoint
        {
            public TeleportPoint(char a, char b, int x, int y, Direction dir)
            {
                Code = $"{a}{b}";
                Point = new Point(x, y);
                LandingPoint = Point.MoveDirection(dir);
            }
            public readonly string Code;
            public Point Point;
            public Point LandingPoint;

            public override string ToString()
            {
                return $"{Code} [{Point}]";
            }
        }

        internal class MazeMap : GridMapChar, ITraverseMap
        {
            public List<TeleportPoint> Teleports = new List<TeleportPoint>();
            public Point StartPoint;
            public Point EndPoint;
            public MazeMap(string input) : base(input)
            {
                int innerDistance = 2;
                while (this[innerDistance, innerDistance] != ' ')
                    innerDistance++;
                for (int x = 1; x < Width - 2; x++)
                {
                    if (char.IsLetter(this[x, 1]))
                        Teleports.Add(new TeleportPoint(this[x, 0], this[x, 1], x, 1, Direction.Down));
                    if (x > innerDistance && x < Width - innerDistance && char.IsLetter(this[x, innerDistance + 1]))
                        Teleports.Add(new TeleportPoint(this[x, innerDistance], this[x, innerDistance + 1], x, innerDistance, Direction.Up));

                    if (char.IsLetter(this[x, Height - 2]))
                        Teleports.Add(new TeleportPoint(this[x, Height - 2], this[x, Height - 1], x, Height - 2, Direction.Up));
                    if (x > innerDistance && x < Width - innerDistance && char.IsLetter(this[x, Height - innerDistance - 1]))
                        Teleports.Add(new TeleportPoint(this[x, Height - innerDistance - 2], this[x, Height - innerDistance - 1], x, Height - innerDistance - 1, Direction.Down));
                }
                for (int y = 1; y < Height - 2; y++)
                {
                    if (char.IsLetter(this[1, y]))
                        Teleports.Add(new TeleportPoint(this[0, y], this[1, y], 1, y, Direction.Right));
                    if (y > innerDistance && y < Height - innerDistance && char.IsLetter(this[innerDistance, y]))
                        Teleports.Add(new TeleportPoint(this[innerDistance, y], this[innerDistance + 1, y], innerDistance, y, Direction.Left));
                    // right wall
                    if (char.IsLetter(this[Width - 2, y]))
                        Teleports.Add(new TeleportPoint(this[Width - 2, y], this[Width - 1, y], Width - 2, y, Direction.Left));
                    if (y > innerDistance && y < Height - innerDistance && char.IsLetter(this[Width - innerDistance - 1, y]))
                        Teleports.Add(new TeleportPoint(this[Width - innerDistance - 2, y], this[Width - innerDistance - 1, y], Width - innerDistance - 1, y, Direction.Right));
                }
                StartPoint = Teleports.Where(t => t.Code == "AA").Single().LandingPoint;
                EndPoint = Teleports.Where(t => t.Code == "ZZ").Single().LandingPoint;
#if DEBUG
                foreach (var t in Teleports)
                {
                    char c = this[t.LandingPoint];
                    if (c != '.') throw new NotSupportedException(t.Code);
                }
#endif
            }

            public override Point TranslatePoint(Point point, Direction dir)
            {
                Point next = point.MoveDirection(dir);
                char pointChar = this[next];
                if (char.IsLetter(pointChar))
                {
                    TeleportPoint teleport = Teleports.Single(t => t.Point == next);
                    if (teleport.Code != "AA" && teleport.Code != "ZZ")
                    {
                        TeleportPoint teleportOtherSide = Teleports.Single(t => t.Code == teleport.Code && t.Point != next);
                        return teleportOtherSide.LandingPoint;
                    }
                }
                return next;
            }

        }

        public MazeMap Map;
        public GridDistanceMap DistanceMap;

        public Day20(string input = Input)
        {
            Map = new MazeMap(input);
            DistanceMap = new GridDistanceMap(Map.Width, Map.Height);
        }

        internal int Part1()
        {
            DistanceMap.CalculateCorridorDistance(Map, Map.EndPoint);
            return DistanceMap[Map.StartPoint];
        }

        internal int Part2()
        {
            throw new NotImplementedException();
        }
    }

    [TestClass]
    public class TestDay20
    {
        [TestMethod]
        public void Example1()
        {
            var d = new Day20(@"
         A           
         A           
  #######.#########  
  #######.........#  
  #######.#######.#  
  #######.#######.#  
  #######.#######.#  
  #####  B    ###.#  
BC...##  C    ###.#  
  ##.##       ###.#  
  ##...DE  F  ###.#  
  #####    G  ###.#  
  #########.#####.#  
DE..#######...###.#  
  #.#########.###.#  
FG..#########.....#  
  ###########.#####  
             Z       
             Z       ");
            Assert.AreEqual(23, d.Part1());
        }

        [TestMethod]
        public void Example2()
        {
            var d = new Day20(@"
                   A               
                   A               
  #################.#############  
  #.#...#...................#.#.#  
  #.#.#.###.###.###.#########.#.#  
  #.#.#.......#...#.....#.#.#...#  
  #.#########.###.#####.#.#.###.#  
  #.............#.#.....#.......#  
  ###.###########.###.#####.#.#.#  
  #.....#        A   C    #.#.#.#  
  #######        S   P    #####.#  
  #.#...#                 #......VT
  #.#.#.#                 #.#####  
  #...#.#               YN....#.#  
  #.###.#                 #####.#  
DI....#.#                 #.....#  
  #####.#                 #.###.#  
ZZ......#               QG....#..AS
  ###.###                 #######  
JO..#.#.#                 #.....#  
  #.#.#.#                 ###.#.#  
  #...#..DI             BU....#..LF
  #####.#                 #.#####  
YN......#               VT..#....QG
  #.###.#                 #.###.#  
  #.#...#                 #.....#  
  ###.###    J L     J    #.#.###  
  #.....#    O F     P    #.#...#  
  #.###.#####.#.#####.#####.###.#  
  #...#.#.#...#.....#.....#.#...#  
  #.#####.###.###.#.#.#########.#  
  #...#.#.....#...#.#.#.#.....#.#  
  #.###.#####.###.###.#.#.#######  
  #.#.........#...#.............#  
  #########.###.###.#############  
           B   J   C               
           U   P   P               ");
            Assert.AreEqual(58, d.Part1());
        }

        [TestMethod]
        public void Part1()
        {
            Assert.AreEqual(568, new Day20().Part1());
        }
        [TestMethod]
        public void Part2()
        {
            Assert.AreEqual(0, new Day20().Part2());
        }
    }

}
