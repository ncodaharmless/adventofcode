using Microsoft.VisualStudio.TestTools.UnitTesting;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AdventOfCode.Year2018
{
    class Day13
    {
        char[,] map;
        int mapHeight;
        int mapWidth;
        List<Cart> carts = new List<Cart>();
        Cart[,] cartMap;
        int globalTickCount;

        public Day13(string input = sample_input)
        {
            int yCoord = 0;
            string[] lines = input.SplitLine();
            mapWidth = lines[0].Length;
            mapHeight = lines.Length;
            map = new char[mapWidth, mapHeight];
            cartMap = new Cart[mapWidth, mapHeight];
            foreach (string line in lines)
            {
                for (int x = 0; x < line.Length; x++)
                {
                    Facing? cartDirection = null;
                    char mapChar = line[x];
                    switch (mapChar)
                    {
                        case '<':
                            cartDirection = Facing.Left;
                            mapChar = '-';
                            break;
                        case '>':
                            cartDirection = Facing.Right;
                            mapChar = '-';
                            break;
                        case 'v':
                            cartDirection = Facing.Down;
                            mapChar = '|';
                            break;
                        case '^':
                            cartDirection = Facing.Up;
                            mapChar = '|';
                            break;
                        case '/':
                        case '\\':
                        case '+':
                        case ' ':
                        case '-':
                        case '|':
                            break;
                        default:
                            throw new NotSupportedException(mapChar.ToString());
                    }
                    if (cartDirection.HasValue)
                    {
                        var cart = new Cart() { X = x, Y = yCoord, Direction = cartDirection.Value };
                        carts.Add(cart);
                        cartMap[x, yCoord] = cart;
                    }
                    map[x, yCoord] = mapChar;
                }
                yCoord++;
            }
        }

        Tuple<int, int> NextCoordForCart(Cart cart)
        {
            switch (cart.Direction)
            {
                case Facing.Left:
                    return new Tuple<int, int>(cart.X - 1, cart.Y);
                case Facing.Right:
                    return new Tuple<int, int>(cart.X + 1, cart.Y);
                case Facing.Up:
                    return new Tuple<int, int>(cart.X, cart.Y - 1);
                case Facing.Down:
                    return new Tuple<int, int>(cart.X, cart.Y + 1);
                default:
                    throw new NotSupportedException();
            }
        }

        public void Tick(bool removeCrashed)
        {
            globalTickCount++;
            for (int y = 0; y < mapHeight; y++)
            {
                for (int x = 0; x < mapWidth; x++)
                {
                    Cart cart = cartMap[x, y];
                    if (cart != null)
                    {
                        if (cart.TickCount == globalTickCount) continue;//already done
                        cart.TickCount = globalTickCount;
                        var next = NextCoordForCart(cart);
                        //remove from old spot
                        cartMap[cart.X, cart.Y] = null;
                        if (cartMap[next.Item1, next.Item2] != null)
                        {
                            var otherCrashedCart = cartMap[next.Item1, next.Item2];
                            otherCrashedCart.IsCrashed = true;
                            if (removeCrashed)
                            {
                                carts.Remove(cart);
                                carts.Remove(otherCrashedCart);
                            }
                            cartMap[next.Item1, next.Item2] = null;
                            continue;
                        }
                        cart.X = next.Item1;
                        cart.Y = next.Item2;
                        cartMap[cart.X, cart.Y] = cart;
                        switch (map[cart.X, cart.Y])
                        {
                            case '|':
                            case '-':
                                // no direction change
                                break;
                            case '/':
                                if (cart.Direction == Facing.Left) cart.Direction = Facing.Down;
                                else if (cart.Direction == Facing.Right) cart.Direction = Facing.Up;
                                else if (cart.Direction == Facing.Up) cart.Direction = Facing.Right;
                                else if (cart.Direction == Facing.Down) cart.Direction = Facing.Left;
                                break;
                            case '\\':
                                if (cart.Direction == Facing.Left) cart.Direction = Facing.Up;
                                else if (cart.Direction == Facing.Right) cart.Direction = Facing.Down;
                                else if (cart.Direction == Facing.Up) cart.Direction = Facing.Left;
                                else if (cart.Direction == Facing.Down) cart.Direction = Facing.Right;
                                break;
                            case '+':
                                // decsion
                                switch (cart.NextTurnStep)
                                {
                                    case IntersectionAction.Left:
                                        if (cart.Direction == Facing.Left) cart.Direction = Facing.Down;
                                        else if (cart.Direction == Facing.Right) cart.Direction = Facing.Up;
                                        else if (cart.Direction == Facing.Up) cart.Direction = Facing.Left;
                                        else if (cart.Direction == Facing.Down) cart.Direction = Facing.Right;
                                        break;
                                    case IntersectionAction.Right:
                                        if (cart.Direction == Facing.Left) cart.Direction = Facing.Up;
                                        else if (cart.Direction == Facing.Right) cart.Direction = Facing.Down;
                                        else if (cart.Direction == Facing.Up) cart.Direction = Facing.Right;
                                        else if (cart.Direction == Facing.Down) cart.Direction = Facing.Left;
                                        break;
                                }
                                cart.NextTurnStep = (IntersectionAction)((((int)cart.NextTurnStep) + 1) % 3);
                                break;
                            default:
                                throw new NotImplementedException(map[cart.X, cart.Y].ToString());
                        }
                    }
                }
            }
        }

        internal void Part1()
        {
            Console.WriteLine(FirstCrashCoord());
        }

        internal void Part2()
        {
            while (carts.Count > 1)
            {
                Tick(true);
            }
            var crashed = carts.Single();
            Console.WriteLine($"{crashed.X},{crashed.Y}");
        }


        internal string FirstCrashCoord()
        {
            while (!carts.Any(c => c.IsCrashed))
            {
                Tick(false);
            }
            var crashed = carts.Where(c => c.IsCrashed).Single();
            return $"{crashed.X},{crashed.Y}";
        }

        #region Input

        const string sample_input = @"
                /----------------------------------------------------------------------------------------------\                                      
   /------------+-----\                                                                   /--------------------+-----------------\                    
   |            |     |                                      /-------------------->-------+<-------------------+------\         /+-------------\      
   |            |     |                                  /---+------\                     |                    |      |         ||             |      
   |            |     |                               /--+---+------+---------------------+--------------------+------+---------++---\  /------+----\ 
   |            |     |                               |  |   |      |         /-----------+--------------------+------+---------++\  |  |      |    | 
   |            |     |    /----------------\         |  |   |      |         |           |               /----+------+---------+++--+--+------+----+\
   |            |     |    |  /-------------+---------+--+---+------+---------+-----------+-----\         |    |      |         |||  |  |      |    ||
   |            |     |    |  |             |         |  |   | /----+---------+-----------+-----+---------+----+----->+----\    |||  |  |      |    ||
   |            |     |    |  |             |         |  |   | |    |    /----+-----------+-----+---------+----+------+----+----+++--+\ |      |    ||
   |            |     |    |  |             |     /---+--+---+-+----+\   |    |           |     |         |    |      |    |    |||  || |      |    ||
   |            |     |    |  |             |     |   |  |   | |/---++---+----+-----------+-----+---------+--\ |      |    |    |||  || |      |    ||
   |            |     |    |  |             |     |   |  |   | ||   ||   |    |           |     |         |  | |      |    |    |||  || |      |    ||
   |            |   /-+----+--+-------------+---\ |   |  |   | ||   ||/--+----+-----------+-----+---------+--+-+----\ |    |    |||  || |      |    ||
   | /----------+---+-+----+--+-------------+---+-+---+--+---+-++---+++--+----+-----------+-----+------\  |  | |    | |    |    |||  || |      |    ||
   | |          |   | |    |  |             |   | |   |  |   | ||   |||  |    |           |     |      |  |  | |    | |    |    |||  || \------+----/|
   | |          |   | |    |  |             |/--+-+---+--+---+-++---+++--+----+-----------+-----+------+--+--+-+----+-+<---+----+++\ ||        |     |
   | |         /+---+-+----+--+-------------++-\| |   |  |   | ||   |||  |    |   /-------+-----+------+--+<-+-+-\  | |    |    |||| ||        |     |
   | |         ||   | |    |  |             || || |   |  |   | ||   |||  |    |   |       |     |      |  |  | | |  | |/---+----++++-++----\   |     |
   |/+--------\||   | |    | /+-----------\ || || |   |  |   | ||   |||  |    |   |       |   /-+------+--+--+-+-+--+-++---+----++++-++----+---+--\  |
   |||        |||   | |    | ||           | || || |   |  |   | ||   |||  |    |   |   /---+---+-+------+--+--+-+-+--+-++---+----++++-++----+-\ |  |  |
   |||        |||   | |    | ||        /--+-++-++-+---+\ |  /+-++---+++--+----+---+---+---+---+>+------+--+--+-+-+--+-++---+-\  |||| ||    | | |  |  |
   |||      /-+++---+-+\   | ||        |  | || || \---++-+--++-++---+/|  |    |   |   |   |   | |      |  |  | | |  | ||   | |  |||| ||    | | |  |  |
   |||      | |||   | ||   |/++--------+--+-++-++-----++-+--++-++---+-+--+----+---+---+---+---+-+\     |  |  | | |  | ||   | |  |||| ||    | | |  |  |
   |||      | |||   | ||   ||||        |  | || ||     || |  |\-++---+-+--+----+---+---+---+---+-++-----+--+--+-+-+--+-/|   | |  |||| ||    | | |  |  |
   |||      | |||   \-++---++++--------+--+-++-+/     || |  |  ||   | |  |    |   |   |   |   | ||     |  |  | | |  |  | /-+-+--++++-++----+-+-+--+\ |
   |||      | |||     ||   ||||        |  | || |    /-++-+--+--++---+-+--+----+---+---+---+---+-++-\   |  |  | | |  |  | | | |  |||| ||    | | |  || |
   |||     /+-+++-----++---++++--------+--+-++-+----+-++-+--+--++---+-+--+----+---+---+---+---+-++-+---+--+\ | | |  |  | | | |  \+++-++----+-+-/  || |
   |||     || ||\-----++---++++--------+--+-++-+----+-++-+--+--++---+-+--+----+---+---+---+---+-++-+---+--++-+-/ |  |  | | | |   ||| ||    | |    || |
   |||     || ||    /-++---++++--------+--+-++-+----+-++-+--+--++---+-+--+----+---+---+---+---+-++-+---+--++-+---+--+--+-+-+-+--\||| ||    | |    || |
   |||     || ||    | ||   ||||        |  | || |    | || |  |  ||   | |  |    |  /+---+---+---+-++-+---+--++-+---+--+--+-+-+-+--++++-++----+-+----++\|
   |||     || ||    | ||   ||||        |  | || |    | ||/+--+--++---+-+--+----+\ ||   |   |   | || |   |  || |   |  |  | | | |  |||| ||    | |    ||||
   |||     || ||    | || /-++++--------+--+-++-+----+-++++--+--++---+-+--+----++-++---+---+---+-++\|   |  || |   |  |  | | | |  |||| ||    | |    ||||
   |||     |\-++----+-+/ | ||||    /---+--+-++-+----+-++++--+--++---+-+--+----++-++---+---+---+-++++---+\ || |   |  |  | | | |  |||| ||    | |    ||||
   |||     |  ||    | |  | ||||    |   |  | || |    | ||||  |  ||   | |  |    || ||   |   |   | ||||   || || |   | /+--+-+-+\|  |||| ||    | |    ||||
   |||     |  ||    | |  | ||||    |   |  | || |    | ||||  |  ||   | |  |    || ||   |   |   | ||||   || || |   | ||  | | |||  |||| ||    | |    ||||
   |||     |  || /--+-+--+-++++----+---+--+-++-+----+-++++--+--++---+-+--+----++-++---+---+---+-++++---++-++-+---+-++\ | | |||  |||| ||    | |    ||||
/--+++-----+--++-+--+-+--+-++++----+---+--+-++-+----+-++++--+--++---+-+--+--\ || ||   |   | /-+-++++---++-++-+---+-+++-+-+-+++--++++-++---\| |    ||||
|  |||     |  || |  \-+--+-++++----+---+--+-++-+----+-++++--+--++---+-+--+--+-++-++---+---+-+-+-++++---++-++-+---+-+++-+-+-+++--/||| ||   || |    ||||
|  |||     |  || |  /-+--+-++++----+---+--+-++-+----+-++++--+--++-\ | |  |  | || ||   |   |/+-+-++++---++-++-+---+\||| | | |||   ||| ||   || |    ||||
|  |||     |  || |  | |  | ||||    |   |/-+-++-+----+-++++--+--++-+-+-+--+--+-++-++---+---+++-+-++++---++-++-+\  ||||| | | |||   ||| ||   || |    ||||
| /+++-----+--++-+--+-+--+-++++----+---++-+-++-+----+-++++--+--++-+-+-+--+--+-++-++---+---+++-+-++++---++\|| ||  ||||| | | |||   ||| ||   || |    ||||
| ||||     |  || |  | |  | ||||    |   || | || |    | \+++--+--++-+-+-+--+--+-++-++---+---+++-+-++++---+++++-++--+++++-+-+-+++---+++-/|   || |    ||||
| ||||     \--++-+--+-+--+-++++----+---++-+-++-+----+--+++--+--++-+-+-+--+--+-++-++---+---+++-+-++++---++++/ ||  ||||| | | |||   |||  |   || |    ||||
| ||||        || |  | |  | ||||    |   || | ||/+----+--+++-\|  || | | |  |  | || ||   |/--+++-+-++++\  ||||  ||  ||||| | | |||   |||  |   || |    ||||
| ||||        || |  | |  | ||||    |   || | ||||/---+--+++-++--++-+>+-+--+--+-++-++---++-\||| | |||||  ||||  ||  ||||| | | |||   |||  |   || |    ||||
| ||||        || |  | |  | ||||    |   || | |||||   |  ||| |\--++-+-+-+--+--+-++-++---++-++++-+-+++++--++++--++--+++++-+-+-++/   |||  |   || |    ||||
| ||||        || |  | |  | ||||    |   || | |||||   |  ||| |   || |/+-+--+--+-++-++---++-++++-+-+++++--++++--++--+++++-+-+-++\   |||  |   || |    ||||
| ||||       /++-+--+-+--+-++++----+---++-+-+++++---+-\||| |   || ||| |  |  | || ||   || |||| | |||||  ||||  ||  ||||| | | |||   |||  |   || v    ||||
| ||||  /----+++-+--+-+--+-++++----+---++-+-+++++---+-++++-+---++-+++\|  |  | \+-++---++-++++-+-+++++--++++--++--+++++-+-+-+++---+/|  |   || |    ||||
| ||||  |/---+++-+--+-+--+-++++----+---++-+-+++++---+-++++-+---++-+++++--+--+--+\||   || |||| | |||||  ||||  ||  ||||| | | |||   | |  |   || |    ||||
| ||||  ||   ||| |  | |  | ||||    |   || | |||||/--+-++++-+---++-+++++--+--+--++++---++-++++-+-+++++--++++-\||  ||\++-+-+-+/|   | |  |   || |    ||||
| |\++--++---+++-+--+-/  | ||||    |   \+-+-++++++--+-+/|| |/--++-+++++--+--+--++++---++-++++-+-+++++--++++-+++--++-++-+-+-+-+---+-+--+-\ || |    ||||
| | ||  ||   ||| |  |    | ||||    |    | | ||||||  | | || ||  || |||||  |  |  ||||   || ||\+-+-+++++--++++-+++--+/ || | | | |   | |  | | || |    ||||
| | ||  ||/--+++-+--+----+-++++----+----+-+-++++++--+-+-++-++--++-+++++--+--+-\||||   || || | | |||||  |||| |||  |  || | | | |   | |  | | || |    ||||
| | ||  |||  ||| |  |    | ||||    |    | | ||||||  | | || ||  || ||||\--+--+-+++++---++-++-+-+-+++++--++++-+++--+--/| | | | |   | |  | | || |    ||||
| | \+--+++--+/| |  |    | ||||    |    | | ||||||  | | || ||  || ||||   |  | |||||   || |\-+-+-+++++--++++-+++--+---+-+-+-+-+---/ |  | | || |    ||||
| |  |  |||  | | |  |    | ||||    |    | | ||||||/-+-+-++-++--++-++++---+--+-+++++---++-+--+-+-+++++--++++-+++--+---+-+\| | |     |  | | || |    ||||
| |  |  |||  | | |  \----+-++++----+----+-+-+++++++-+-+-++-++--++-/|||   |  | |||||   ||/+--+-+-+++++--++++-+++\ |   | ||| | |     |  | | || |    ||||
| |  |  |||  | | |       | ||||    |    | | ||\++++-+-+-++-/|/-++--+++---+--+-+++++-\ |||| /+-+-+++++--++++-++++-+---+-+++\| |     |  | | || |    ||||
| |  | /+++--+-+-+-------+-++++----+----+-+-++-++++-+-+-++--++\||  |||   |  | ||||| | |||| || | |||||  |||| |||| |   | ||||| |     |  |/+-++-+---\||||
| |  | ||||  | | |       | ||||    |    | | || |||| | | ||  |||||  |||   |  | ||||| | |||| || | |||||  |||| |||| |   | ||||| |     |  ||| || |   |||||
| |  | ||||  | | |       | ||||    |    | | || |||| | | ||  |||||  |||   |  | ||||\-+-++++-++-+-+++++--++++-++++-/   | ||||| |     |  ||| || |   |||||
| |  | ||||  | | |       | ||||    |    | | || |||| | | ||  |||||  |||   |  | ||||  | ||||/++-+-+++++--++++-++++-----+-+++++-+--\/-+--+++-++-+--\|||||
| |  | ||||  | | |       | ||||    |    | | || |||| | | ||  |||||  |||   |  | ||||  | |\+++++-+-++++/  |||\-++++-----+-+++++-+--++-+--+++-++-+--+++++/
| |  | ||||  | | |     /-+-++++----+--\ | | || |||| | | ||  |||||  |||   |/-+-++++--+-+-+++++-+\||||   |||  ||||     | ||||| |  || |  ||| || |  ||||| 
| |  | ||||  | | |     | | ||||    |  | | | || |||| | | ||  |||||  |||   || | ||||  | | ||||| ||||||   |||  ||||     | ||||| |  || |  ||| || |  ||||| 
| |  | ||||  | | |     | | \+++----+--+-+-+-/| |||| | | ||  |||||  |||   || | ||||  | | ||||| ||||||   |||  ||||     | ||||| |  || |  ||| || |  ||||| 
| |  | |||\--+-+-+-----+-+--+++----+--+-+-+--+-++++-+-+-++--+++++--+++---++-+-/|||  |/+-+++++-++++++---+++\ ||||     | ||||v |  || |  ||| || |  ||||| 
| |  | |||   | | |     | |  |||    |  | |/+--+-++++-+-+\||  |||||  |||   || |  |||  ||| |||||/++++++---++++-++++-----+-+++++-+--++-+-\||| || |  ||||| 
| |  | |||   | | |/----+-+--+++\   |  | |||  | ||\+-+-++++--+++++--+++---++-+--+++--+++-++++++++++++---++++-/|||    /+-+++++-+--++-+-++++-++-+-\||||| 
| |  | |||   | | ||    | |  |\++---+--+-++/  | || | | ||||  ||||\--+++---++-+--+++--+++-++++++++++++---++++--/||    || ||||| |  || | |||| || | |||||| 
|/+--+-+++---+-+-++----+-+--+-++---+--+-++---+-++-+-+-++++--++++---+++---++-+--+++--+++-++++++++++++-\ ||||   ||    || ||||| |  || | |||| || | |||||| 
|||  | |||   | | ||  /-+-+--+-++---+--+-++---+-++-+-+-++++--++++-\ |||   || |  |||/-+++-++++++++++++-+-++++---++----++-+++++-+--++-+\|||| || | |||||| 
^||  | |||   | | ||  | | |  | ||   |  | ||   \-++-+-+-++++--++++-+-+++---++-+--++++-+++-++++++++++++-+-++++---++----++-+++++-+--++-/||||| || | |||||| 
|||  | |||   | | ||  | | |  | ||   |/-+-++-----++-+-+-++++--++++-+-+++---++-+--++++-+++>++++++++++++-+-++++---++----++-+++++-+\ ||  ||||| || | |||||| 
|||  | \++---+-+-++--+-+-+--+-++---++-+-++-----++-+-+-++++--++/| | |||   || |  |||| ||| \+++++++++++-+-++++---+/    || ||||| || |\--+++++-++-+-+/|||| 
|||  |  ||   | | ||  | | |  | ||   || | ||     || | | ||||  || | |/+++---++-+--++++-+++--+++++++++++-+-++++\  |     || ||||| || |   ||||| || | | |||| 
|||  |  ||   | | ||  | | |  | ||   || | ||    /++-+-+-++++--++-+-+++++--\|| |  |||| |||  ||||||||||| | |||||  | /---++-+++++-++-+---+++++\|| | | |||| 
|||  |  ||   | | ||  | | |  | ||   || | ||    ||| | | ||||  || | |||||  ||| |  |||| ||\--+++++++++++-+-+++++--+-+---++-+++++-++-+---++++++++-/ | |||| 
|||  |  ||   | | || /+-+-+--+-++---++-+-++----+++\| | ||||  || | |||||  |\+-+--++++-++---+++++++++++-+-+++++--+-+---++-+++++-++-+---++/|||||   | |||| 
|||  |  ||   |/+-++-++-+-+--+-++---++-+-++----+++++\| ||||  || | |||||  | | |  |||| ||   ||||||||||| | |||||  | |   || ||||| || |   || |||||   | |||| 
|||  |  ||   ||| || || | |  | ||   || | ||    ||||||| ||||  |\-+-+++++--+-+-+--++++-/|   ||||||||||| | |||||  | |   || ||||| || |   || |||||   | |||| 
|||  |  ||   |||/++-++-+-+--+-++---++-+-++----+++++++-++++--+--+-+++++--+-+-+--++++--+---+++++++++++\| |||||  | |   || ||||| || |   || |||||   | |||| 
|||  |  ||   |||||| || |/+--+-++---++-+-++----+++++++-++++--+--+-+++++--+-+-+--++++--+-\ v|||||||||||| |||||  | |   || ||||| || |   || |||||   | |||| 
|||  |  ||   |||||| || |||  | ||   || | ||    ||||||| ||||  |  | |||||  | | |  ||||  | | |||||||||||||/+++++--+-+---++-+++++-++-+---++-+++++---+-++++\
|||  |  ||   |||||| || |||/-+-++---++\| ||    ||||||| ||||  |  \-+++++--+-+-+--++++--+-+-+++++++++++++++++++--+-+---++-++++/ || |   || |||||   | |||||
|||  |  ||   |||||| || |||| | ||   |||| ||    ||||||\-++++--+----+++++--+-+-+--++++--+-+-++++++++++/||||||||  | |   || ||||  || |   || |||||   | |||||
|||  |  ||   |||||| || |||| | ||   |||| ||    ||||||  ||||  |    |||||  | | |  |||v  \-+-++++++++++-++++++/|  | |   || ||||  || |   || |||||   | |||||
|||  |  ||  /++++++-++\|||| |/++---++++-++----++++++--++++--+----+++++--+-+-+--++++----+-++++++++++-++++++-+--+-+---++-++++--++-+\  || |||||   | |||||
|||  |  ||  |\+++++-+++++++-++++---++++-++----++++++--/||\--+----+++/|  | | |  ||||    | |||||\++++-++++++-+--+-+---++-++++--++-++--++-+++++---+-+/|||
|||  |  ||  | ||||| ||||||| ||||   |||| ||  /-++++++---++---+----+++-+--+-+-+--++++----+-+++++-++++-++++++-+--+-+---++-++++--++\||  || |||||   | | |||
|||  |  ||  | ||||| ||||||| ||||   |||| ||  | ||||||   ||   |    ||| |  | | |  ||||    | ||||\-++++-++++++-+--+-+---++-++++--+++++--+/ |||||   | | |||
|||  \--++--+-+++++-+++++++-++++---++++-++--+-++++++---++---+----+++-+--+-+-+--++++----+-++++--++++-+++/|| |  | |   || ||||  |||||  |  |||||   | | |||
||| /---++--+-+++++-+++++++-++++---++++-++--+-++++++---++---+----+++-+--+-+-+--++++----+-++++-\|||| ||| || |  | |   || ||||  |||||  |  |||||   | | |||
||| |   ||  | ||||| ||||||| ||||   |||| ||  | ||||||   ||   |    ||| |  | | |  ||||    | |||| ||||| ||| || |  | |   || \+++--+++++--+--++++/   | | |||
||| |   ||  | ||||| ||||||| ||||   |\++-++--+-++++++---++---+----+++-+--+-+-+--++++----+-++++-+++++-+++-++-+--+-+---++--+++--+/|||  |  ||||    | | |||
||| |   ||  | ||||| ||||||| ||||/--+-++-++--+-++++++---++---+---\||| |  | | | /++++----+-++++-+++++-+++-++-+\ | |   ||  |||  | |||  |  ||||    | | |||
|\+-+---++--+-+++++-+++++++-+++++--+-++-++--+-++++++---++---+---++++-+--+-+-+-+++++----+-++++-+++++-+/| || || | |   ||  |||  | |||  |  ||||    | | |||
| | |   ||  | ||||| ||||||| |\+++--+-++-++--+-++++++---++---+---++++-+--+-+-+-+++++----+-++++-+++++-+-+-++-++-+-+--<++--+++--+-++/  |  ||||    | | |||
| | |   ||  | ||||| |||\+++-+-+++--+-+/ ||  | ||||||   ||   \---++++-+--+-+-+-+++++----+-++++-+++++-+-+-++-++-+-+---++--+++--+-++---+--+/||    | | |||
| | |   \+--+-+++++-+++-+++-+-+++--+-+--++--+-++++++---++-------++++-/  | | | |||\+----+-++++-+++++-+-+-++-++-+-+---++--+++--+-++---+--+-++----+-+-+/|
| | |    |  | ||||| ||| ||| \-+++--+-+--++--+-++++++---++-------++++----+-+-+-+++-+----+-++++-+++/| | | || || | |   ||  |||  | ||   |  | ||    | | | |
| | |    |  | ||||| ||| |||   |||  | |/-++--+-++++++---++-------++++----+-+-+-+++-+----+-++++-+++-+-+-+-++-++-+-+---++--+++--+-++---+--+\||    | | | |
| | |    |  | ||||| ||| |||   |||  | || ||/-+-++++++---++-------++++----+-+-+-+++-+\   | |||| ||| | | | || || | |   ||  |||  | ||   |  ||||    | | | |
| | |    |  |/+++++-+++-+++---+++--+\|| ||| | ||||||   ||     /-++++----+-+-+-+++-++---+-++++-+++-+-+-+-++-++-+-+---++--+++--+-++---+--++++\   | | | |
| | |    |  ||||||| ||| |||   |||  |||| ||| | ||||||   ||  /--+-++++----+-+-+-+++-++---+-++++-+++-+-+-+-++-++-+-+>\ ||  |||  | ||   |  |||||   | | | |
| | |    |  ||||||| ||| |||   |||  |||| ||| | ||||||   ||  |  | ||||    | \-+-+++-++---+-++++-+/| | | | || || | | | ||  |||  | ||   |  |||||   | | | |
| | |    |  ||||||| ||| |||   |||/-++++-+++-+-++++++---++--+--+-++++----+---+-+++-++---+-++++-+-+-+-+-+-++-++-+-+-+-++--+++--+-++---+-\|||||   | | | |
| | |    |  ||||||| ||| |||   \+++-++++-+++-+-++++++---++--+--+-++++----+---+-+++-++---+-++++-+-/ | | | || || | | | ||  |||  | ||   | ||||||   | | | |
| | |    |  ||||||| ||| |||    ||| |||| \++-+-++++++---++--+--+-++++----+---+-+++-++---+-++++-+---+-+-+-++-++-/ | | ||  |||  | ||   | ||||||   | | | |
| | |  /-+--+++++++-+++-+++----+++-++++--++-+-++++++---++--+--+-++++----+---+-+++-++---+-++++-+---+-+-+-++-++---+-+\||  |||  | ||   | ||||||   | | | |
| | |  | |  ||||||| ||| |||    ||| ||||  || | ||\+++---++--+--+-++++----+---+-+++-++---+-/||| |   | | | || ||   | ||||  |||  | ||   | ||||||   | | | |
| | |  | |  ||||||| ||| |||    ||| ||||  || | || |||   ||  |  | ||||    |   | ||| ||   |  ||| |   | | | || ||   | ||||  |||  | ||   | ||||||   | | | |
| | |  | |  |||\+++-+++-+++----+++-++++--++-+-+/ |||   ||  |  | ||\+----+---+-+++-++---+--+++-+---+-+-+-++-/|   | ||||  |||  | ||   | ||||||   | | | |
| | |  | |  ||| ||| ||| |||    ||| ||||  || | |  |||   ||  |  | || |    |   | ||| ||   |  ||| |   | | | ||  |   \-++++--+++--+-++---+-+++/||   | | | |
| | |  | |  ||| ||| |\+-+++----+++-++++--++-+-+--+++---++--+--+-+/ |    |   | ||| ||   |  ||| |   | | | ||  |     ||||  |||  | ||   | ||| ||   | | | |
| | |  | |  ||| ||| | | |||    ||| ||||  || | |  |||   ||  |  | |  |    |   | ||| ||   |  ||| |   | | | ||  |     ||||  |||  | ||   | ||| ||   | | | |
| \-+--+-+--+++-+++-+-+-+++----+++-++++--++-+-+--+++---++--+--+-+--+----+---+-+++-++---+--+++-+---+-+-+-+/  |     ||||  |||  | ||   | ||| ||   | | | |
|   |  | |  ||| ||| | | |||    ||| ||||  || | |  |||   ||  |  | |  |    |   | ||| ||   |  ||| |   | | | |   |     ||||  |||  | ||   | ||| ||   | | | |
|   |  | |  ||| ||| | | |||    ||| ||||  || | \--+++---++--+--+-+--+----/   | ||| ||   |  ||| |   | | | |   |     ||\+--+++--+-++---+-+++-++---/ | | |
\---+--+-+--+++-+++-+-+-+++----+++-++++--++-+----+++---++--+--+-+--+--------/ ||| ||   |  ||| |   | | | |   |     || |  |||  | ||   | ||| ||     | | |
    |  | |  ||| ||| | | |||    ||| ||||  || |    |||   ||  |  \-+--+----------+++-++---+--+++-+---+-+-+-+---+-----++-+--+++--+-++---+-+++-+/     | | |
    |  | |  ||| ||| | | \++----+++-++++--++-+----+++---++--+----+--+----------+++-++---/  ||| |   | | | |   |     || |  |||  | ||   | |\+-+------/ | |
    |  | |  ||| ||| | |  ||    ||| ||||  || |    |||   ||  |    |/-+----------+++-++--\   ||| |   | | | |   |     || |  |||  | ||   | | | |        | |
    |  | |  ||| ||| | |  ||    ||| ||||  || |    |||   ||  |    || |          ||| ||  |   ||| |  /+-+-+-+---+-----++-+--+++--+-++---+-+-+\|        | |
    |  | |  ||| ||| | |  ||    ||| ||||  || |    |||   ||  |    || \----------+++-++--+---+++-+--++-+-+-+---+-----++-+--+++--/ ||   | | |||        | |
    |  | |  ||| ||| | |  \+----+++-++++--++-+----+++---++--+----++------------+++-++--+---+++-+--+/ | | |   |     || |  |||    ||   | | |||        | |
    |  | |  |\+-+++-+-+---+----+++-+/||  || |    |||   ||  |    ||            ||| ||  |   \++-+--+--+-+-+---+-----++-+--+++----+/   | | |||        | |
    |  | |  | | ||| \-+---+----+++-+-++--++-+----/||   ||  |    ||            ||| ||  |    || |  |  | | |   |     || |  |||    |    | | |||        | |
    |  | |  | \-+++---+---+----+++-+-++--++-+-----+/   ||  |    ||            \++-++--+----++-+--+--+-+-+---/     || |  |\+----+----+-+-+++--------/ |
    |  | |  |   |||   |   v    ||| \-++--++-+-----+----++--+----++-------------++-++--+----++-+--+--+-+-/         || |  | |    |    | | |||          |
    |  | |  |   |||   |   |    |\+---++--++-+-----+----++--+----/|             || || /+----++-+--+--+-+-----------++-+--+-+----+---\| | |||          |
    |  \-+--+---+++---+---+----+-+---++--++-+-----+----++--+-----+-------------++-++-++----++-+--+--+-+-----------+/ |  | |    |   || | |||          |
    |    |  |   |||   |   |    | |   ||  || |     |    |\--+-----+-------------/| || ||    || |  |  | |           |  |  | |    |   || | |||          |
    |    |  |   |||   |   |    | |   ||  || \-----+----+---+-----+--------------+-++-++----++-+--+--+-+-----------+--+--+-+----/   || | |||          |
    |    |  |   |||   |   |    | |   ||  ||       |    |   |     \--------------+-++-+/    \+-+--+--+-+-----------+--+--+-/        || | |||          |
    |    |  |   |||   |   |    | |   ||  \+-------+----/   |                    | || |      | |  |  | \-----------+--+--+----------++-+-+++----------/
    |    |  |   |\+---+---+----+-+---++---+-------+--------+--------------------+-++-+------+-+--+--+-------------+--/  |          || | |||           
    |    \--+---+-+---+---+----+-+---++---+-------+--------+--------------------/ || |      | |  |  |             |     |          || | |||           
    |       |   | |   |   |    | |   ||   |       |        \----------------------++-+------+-+--+--+-------------/     |          || | |||           
    |       |   | |   |   |    | |   ||   |       |                               || \------+-+--+--+-------------------+----------/| | |||           
    |       |   | |   |   |    | \---++---+-------+-------------------------------++--------+-+--+--+-------------------+-----------+-/ |||           
    |       |   | |   |   |    |     ||   |       |                               ||        \-+--+--+-------------------+-----------+---++/           
    |       \---+-+---/   |    |     ||   |       |                               \+----------+--+--+-------------------+-----------/   ||            
    \-----------+<+-------+----+-----++---+-------+--------------------------------+----------/  |  |                   |               ||            
                \-+-------+----+-----++---+-------+--------------------------------+-------------+--/                   |               ||            
                  |       \----+-----/\---+-------+--------------------------------+-------------+----------------------+---------------/|            
                  \------------/          |       \--------------------------------+-------------+----------------------/                |            
                                          \----------------------------------------/             \---------------------------------------/            ";

        #endregion
    }

    class Cart
    {
        public int X;
        public int Y;
        public IntersectionAction NextTurnStep;
        public Facing Direction;
        public bool IsCrashed;
        public int TickCount;

        public override string ToString()
        {
            return $"{X},{Y}";
        }
    }

    enum IntersectionAction { Left, Straight, Right }
    enum Facing { Left, Right, Up, Down }

    [TestClass]
    public class TestDay13
    {
        [TestMethod]
        public void TestSample()
        {
            string input = @"
/->-\        
|   |  /----\
| /-+--+-\  |
| | |  | v  |
\-+-/  \-+--/
  \------/   ";
            var day13 = new Day13(input);
            Assert.AreEqual("7,3", day13.FirstCrashCoord());
        }
    }
}
